# action.yml
name: "Mobb"
description: "Mobb analyzer automatic security fixer action"
inputs:
  report-file:
    description: "Path to SAST report file"
    required: true
  api-key:
    description: "Mobb API key"
    required: true
  github-token:
    description: "GitaHub Token"
    required: true
outputs:
  fix-report-url:
    description: "Mobb fix report URL"
    value: ${{ steps.run-npx-mobb-dev.outputs.fix-report-url }}
runs:
  using: "composite"
  steps:
    - uses: actions/setup-node@v3.6.0
      with:
        node-version: 18
    - id: run-npx-mobb-dev
      run: |
        set -x
        REPO=$(git remote get-url origin)
        REPO=${REPO%".git"}
        BRANCH=$(git rev-parse --abbrev-ref HEAD)
        echo npx --yes mobbdev@latest analyze -y -r $REPO -b $BRANCH -k ${{ inputs.api-key }} -f ${{ inputs.report-file }}
        # npx --yes mobbdev@latest analyze --help
        # DEBUG=* npx --yes mobbdev@latest analyze -y -r $REPO -b $BRANCH -k ${{ inputs.api-key }} -f ${{ inputs.report-file }}
        OUT=$(! npx --yes mobbdev@latest analyze -y -r $REPO -b $BRANCH -k ${{ inputs.api-key }} -f ${{ inputs.report-file }})
        RETVAL=$?
        if [ $RETVAL -ne 0 ]; then
          exit $RETVAL
        fi
        echo $?
        OUT=$(echo $OUT | tr '\n' ' ')
        echo "fix-report-url=$OUT" >> $GITHUB_OUTPUT
        echo $GITHUB_OUTPUT
        cat $GITHUB_OUTPUT
      shell: bash -l {0}
    - uses: LouisBrunner/checks-action@v1.3.1
      with:
        token: ${{ inputs.github-token }}
        name: Test With Details
        conclusion: success
        output: |
          {"summary":"Test  was a success","text_description": "${{steps.run-npx-mobb-dev.outputs.fix-report-url}}" }
