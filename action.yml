# action.yml
name: "Mobb"
description: "Mobb analyzer automatic security fixer action"
inputs:
  report-file:
    description: "Path to SAST report file"
    required: true
  api-key:
    description: "Mobb API key"
    required: true
outputs:
  fix-report-url:
    description: "Mobb fix report URL"
    value: ${{ steps.run-npx-mobb-dev.outputs.fix-report-url }}
runs:
  using: "composite"
  steps:
    - uses: actions/setup-node@v3.6.0
      with:
        node-version: 18
    - id: run-npx-mobb-dev
      run: |
        REPO=$(git remote get-url origin)
        REPO=${REPO%".git"}
        BRANCH=$(git rev-parse --abbrev-ref HEAD)
        npm config set unsafe-perm true
        echo npx --yes mobbdev@latest analyze -y -r $REPO -b $BRANCH -k ${{ inputs.api-key }} -f ${{ inputs.report-file }}
        npx --yes mobbdev@latest analyze --help
        DEBUG=* npx --yes mobbdev@latest analyze -y -r $REPO -b $BRANCH -k ${{ inputs.api-key }} -f ${{ inputs.report-file }}
        echo "fix-report-url=$(npx --yes mobbdev@latest analyze -y -r $REPO -b $BRANCH -k ${{ inputs.api-key }} -f ${{ inputs.report-file }})" >> $GITHUB_OUTPUT
      shell: bash -l {0}
    - uses: LouisBrunner/checks-action@v1.3.1
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        name: Test With Details
        conclusion: success
        output: |
          {"summary":"Test was a success","text_description": ${{ steps.run-npx-mobb-dev.outputs.fix-report-url }} }
        #action_url: ${{ steps.run-npx-mobb-dev.outputs.fix-report-url }}
        #details_url: ${{ steps.run-npx-mobb-dev.outputs.fix-report-url }}
